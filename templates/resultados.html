<!DOCTYPE html>
<html lang="es">
<head>
    <style>
body {
  position: relative;
  background-image: url("{{ url_for('static', filename='img/fondoresultados.jpg') }}");
  background-size: cover;
  background-position: center;
  background-attachment: fixed;
  overflow-x: hidden;
}

/* Capa difuminada encima del fondo */
body::before {
  content: "";
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(255, 255, 255, 0.5);
  backdrop-filter: blur(3px);
  -webkit-backdrop-filter: blur(3px);
  z-index: -1; /* Esto asegura que el contenido quede por encima */
}
</style>


    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resultados del AnÃ¡lisis - EduQuantum</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Estilos -->
    <style>
        body { background-color: #f8f9fa; }
        .navbar { background-color: #007bff; }
        .navbar-brand, .nav-link, .navbar-text { color: #fff !important; }
        .table th { background-color: #007bff; color: white; text-align: center; }
        .table td { text-align: center; vertical-align: middle; }
        .badge { font-size: 0.9rem; }
        .container { margin-top: 2rem; margin-bottom: 3rem; }
        .download-btn { margin-bottom: 1.5rem; }
        .chart-card { padding: 16px; background: #fff; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.06); }
        .hidden { display:none; }
        .top-controls { display:flex; justify-content:center; gap:8px; align-items:center; margin-bottom:16px; }
        .small-note { font-size:0.9rem; color:#666; }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg">
        <div class="container-fluid">
            <a class="navbar-brand fw-bold" href="{{ url_for('index') }}">EduQuantum</a>
            <div class="d-flex align-items-center ms-auto">
                <span class="navbar-text me-3">ðŸ‘‹ Hola, {{ profesor }}</span>
                <a href="{{ url_for('logout') }}" class="btn btn-outline-light btn-sm">Cerrar sesiÃ³n</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <h2 class="text-center mb-3">ðŸ“Š Resultados del AnÃ¡lisis de Riesgo de DeserciÃ³n</h2>

        <!-- Controls: descarga y dashboard toggle -->
        <div class="top-controls">
            <a href="{{ excel_path }}" class="btn btn-success" download>ðŸ“¥ Descargar resultados en Excel</a>
            <button id="btn-toggle-dashboard" class="btn btn-primary">ðŸ“Š Dashboard</button>
            <span class="small-note">Alterna entre tabla de resultados y vistas grÃ¡ficas</span>
        </div>

        <!-- Contenedor del dashboard (oculto por defecto) -->
        <div id="dashboard-area" class="hidden mb-4">
            <div class="row g-3">
                <div class="col-lg-4">
                    <div class="chart-card">
                        <h6 class="text-center">Estudiantes en riesgo (SÃ­ / No)</h6>
                        <canvas id="chart-risk-pie" height="220"></canvas>
                    </div>
                </div>
                <div class="col-lg-4">
                    <div class="chart-card">
                        <h6 class="text-center">Materias con mÃ¡s deserciÃ³n (top 10)</h6>
                        <canvas id="chart-materias-bar" height="220"></canvas>
                    </div>
                </div>
                <div class="col-lg-4">
                    <div class="chart-card">
                        <h6 class="text-center">DeserciÃ³n por faltas</h6>
                        <canvas id="chart-faltas-donut" height="220"></canvas>
                        <p class="small-note mt-2 text-center">Porcentaje de estudiantes con faltas â‰¥ 13 frente al total.</p>
                    </div>
                </div>
            </div>

            <!-- Detalle adicional: por programa -->
            <div class="row mt-3">
                <div class="col-12 chart-card">
                    <h6 class="text-center mb-2">Tasa de deserciÃ³n por Programa AcadÃ©mico (top 10)</h6>
                    <canvas id="chart-programa-bar" height="120"></canvas>
                </div>
            </div>
        </div>

        <!-- Contenedor de la tabla -->
        <div id="table-area">
            <div class="table-responsive">
                <table class="table table-bordered table-hover shadow-sm">
                    <thead>
                        <tr>
                            <th>Programa AcadÃ©mico</th>
                            <th>Nombre del Estudiante</th>
                            <th>Materia</th>
                            <th>Nota 1</th>
                            <th>Nota 2</th>
                            <th>Fallas 1</th>
                            <th>Fallas 2</th>
                            <th>Vez Vista</th>
                            <th>En Riesgo</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for fila in datos %}
                        <tr>
                            <td>{{ fila.PROGRAMA_ACADEMICO }}</td>
                            <td>{{ fila.APELLIDOS_Y_NOMBRES }}</td>
                            <td>{{ fila.NOM_MATERIA }}</td>
                            <td>{{ fila.NOTA1 }}</td>
                            <td>{{ fila.NOTA2 }}</td>
                            <td>{{ fila.FALLAS1 }}</td>
                            <td>{{ fila.FALLAS2 }}</td>
                            <td>{{ fila.VEZVISTA }}</td>
                            <td>
                                {% if fila.En_Riesgo == "SÃ­" %}
                                    <span class="badge bg-danger">SÃ­</span>
                                {% else %}
                                    <span class="badge bg-success">No</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if fila.En_Riesgo == "SÃ­" %}
                                <button class="btn btn-sm btn-outline-info mb-1 btn-sugerencia" type="button"
                                    data-nombre="{{ fila.APELLIDOS_Y_NOMBRES }}"
                                    data-nota1="{{ fila.NOTA1 }}"
                                    data-nota2="{{ fila.NOTA2 }}"
                                    data-fallas1="{{ fila.FALLAS1 }}"
                                    data-fallas2="{{ fila.FALLAS2 }}">
                                    ðŸ’¬ Sugerencia
                                </button>
                                <div class="form-check mt-1">
                                    <input class="form-check-input seleccionar-riesgo" type="checkbox"
                                        value='{{ fila | tojson }}'>
                                    <label class="form-check-label">Guardar</label>
                                </div>
                                {% else %}
                                    <span class="text-muted">â€”</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <div class="d-flex justify-content-center mt-3">
                <button id="btn-guardar-riesgo" class="btn btn-warning">ðŸ’¾ Guardar seleccionados en Firebase</button>
            </div>
        </div>

        <!-- Modal sugerencia -->
        <div class="modal fade" id="sugerenciaModal" tabindex="-1" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">Sugerencia para el docente</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body" id="sugerencia-contenido"></div>
              <div class="modal-footer">
                <a id="btn-reportar-sugerencia" class="btn btn-primary" style="display:none;" href="#">Reportar</a>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Modal mis guardados -->
        <div class="modal fade" id="misGuardadosModalBottom" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Estudiantes guardados</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body" id="mis-guardados-contenido-bottom">
                        <div id="mis-guardados-list-bottom">Cargando...</div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="text-center mt-3">
            <a href="{{ url_for('index') }}" class="btn btn-primary">â¬… Volver al inicio</a>
        </div>
    </div>

    <!-- Footer -->
    <footer class="text-center py-3 bg-light mt-auto border-top">
        <small>Â© 2025 EduQuantum | Sistema de PredicciÃ³n de DeserciÃ³n AcadÃ©mica</small>
    </footer>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
    // Pasar los datos server->JS
    const datos = {{ datos|tojson }};

    // DOM elements
    const btnToggle = document.getElementById('btn-toggle-dashboard');
    const dashboardArea = document.getElementById('dashboard-area');
    const tableArea = document.getElementById('table-area');

    let showingDashboard = false;
    let charts = {}; // guardar instancias de Chart.js

    btnToggle.addEventListener('click', () => {
        showingDashboard = !showingDashboard;
        if (showingDashboard) {
            btnToggle.innerText = 'ðŸ”™ Ver tabla';
            tableArea.classList.add('hidden');
            dashboardArea.classList.remove('hidden');
            buildCharts(); // construir al mostrar
        } else {
            btnToggle.innerText = 'ðŸ“Š Dashboard';
            dashboardArea.classList.add('hidden');
            tableArea.classList.remove('hidden');
        }
    });

    // Funciones para calcular mÃ©tricas
    function safeNum(x){ const n = Number(x); return Number.isFinite(n) ? n : 0; }

    function computeStats(data){
        const total = data.length;
        const riskCount = data.filter(d => String(d.En_Riesgo).toLowerCase() === 'sÃ­' || String(d.En_Riesgo) === 'Si' || String(d.En_Riesgo) === 'SÃ').length;
        const nonRiskCount = total - riskCount;

        // Materias con mayor desercion: contar En_Riesgo == 'SÃ­' por NOM_MATERIA
        const matCounts = {};
        data.forEach(d => {
            const materia = d.NOM_MATERIA || 'Sin materia';
            const en = String(d.En_Riesgo).toLowerCase() === 'sÃ­' || String(d.En_Riesgo) === 'si';
            if (!matCounts[materia]) matCounts[materia] = { risk:0, total:0 };
            if (en) matCounts[materia].risk += 1;
            matCounts[materia].total += 1;
        });
        const materiasArr = Object.entries(matCounts).map(([m, v]) => ({ materia: m, risk: v.risk, total: v.total }));

        // Faltas totales por estudiante y contar quienes superan >=13
        let faltasTotales = data.map(d => safeNum(d.FALLAS1) + safeNum(d.FALLAS2));
        let faltasCount = faltasTotales.filter(x => x >= 13).length;

        // Entre los en riesgo, cuÃ¡ntos son por faltas >=13
        const riskByFaltas = data.filter(d => {
            const en = String(d.En_Riesgo).toLowerCase() === 'sÃ­' || String(d.En_Riesgo) === 'si';
            const f = (safeNum(d.FALLAS1) + safeNum(d.FALLAS2));
            return en && f >= 13;
        }).length;

        // Por programa: tasa de desercion = risk / total por programa
        const prog = {};
        data.forEach(d => {
            const p = d.PROGRAMA_ACADEMICO || 'Sin programa';
            const en = String(d.En_Riesgo).toLowerCase() === 'sÃ­' || String(d.En_Riesgo) === 'si';
            if (!prog[p]) prog[p] = { risk:0, total:0 };
            if (en) prog[p].risk += 1;
            prog[p].total += 1;
        });
        const progArr = Object.entries(prog).map(([p,v]) => ({ programa: p, risk: v.risk, total: v.total, rate: v.total ? (v.risk / v.total) : 0 }));

        return {
            total, riskCount, nonRiskCount,
            materiasArr, faltasCount, riskByFaltas, progArr
        };
    }

    function buildCharts(){
        // Si ya construidos, destruir para reconstruir (evita duplicados)
        Object.values(charts).forEach(c => { try{ c.destroy(); }catch(e){} });
        charts = {};

        const stats = computeStats(datos);

        // --- Pie: riesgo SÃ­/No
        const ctxPie = document.getElementById('chart-risk-pie').getContext('2d');
        charts.riskPie = new Chart(ctxPie, {
            type: 'pie',
            data: {
                labels: ['No (Seguros)', 'SÃ­ (En riesgo)'],
                datasets: [{
                    data: [stats.nonRiskCount, stats.riskCount],
                    backgroundColor: ['#28a745', '#dc3545']
                }]
            },
            options: {
                responsive: true,
                plugins: { legend: { position: 'bottom' } }
            }
        });

        // --- Materias con mÃ¡s deserciÃ³n (top 10 por count)
        const sortedMat = stats.materiasArr.sort((a,b)=>b.risk - a.risk).slice(0,10);
        const matLabels = sortedMat.map(x=>x.materia);
        const matData = sortedMat.map(x=>x.risk);
        const ctxBar = document.getElementById('chart-materias-bar').getContext('2d');
        charts.matBar = new Chart(ctxBar, {
            type: 'bar',
            data: {
                labels: matLabels,
                datasets: [{ label: 'Estudiantes en riesgo por materia', data: matData }]
            },
            options: { responsive:true, indexAxis: 'y', plugins:{ legend:{ display:false } } }
        });

        // --- Faltas donut: % con faltas >=13 vs resto
        const ctxDonut = document.getElementById('chart-faltas-donut').getContext('2d');
        charts.faltasDonut = new Chart(ctxDonut, {
            type: 'doughnut',
            data: {
                labels: ['Faltas â‰¥ 13', 'Resto'],
                datasets: [{ data: [stats.faltasCount, stats.total - stats.faltasCount], backgroundColor: ['#ffc107','#6c757d'] }]
            },
            options: { responsive:true, plugins:{ legend:{ position:'bottom' } } }
        });

        // --- Programa: top 10 por tasa (rate)
        const sortedProg = stats.progArr.sort((a,b)=>b.rate - a.rate).slice(0,10);
        const progLabels = sortedProg.map(p=>p.programa);
        const progData = sortedProg.map(p => Math.round(p.rate * 100));
        const ctxProg = document.getElementById('chart-programa-bar').getContext('2d');
        charts.progBar = new Chart(ctxProg, {
            type: 'bar',
            data: { labels: progLabels, datasets: [{ label: '% deserciÃ³n', data: progData }] },
            options: { responsive:true, plugins:{ legend:{ display:false } }, scales: { y: { beginAtZero:true, ticks:{ callback: v => v + '%' } } } }
        });

        // Opcional: mostrar nÃºmeros en consola (debug)
        console.log('stats', stats);
    }

    // --- Reusar el JS existente para sugerencias/guardar/mis guardados (adaptado) ---
    document.querySelectorAll('.btn-sugerencia').forEach(btn => {
        btn.addEventListener('click', async (e) => {
            const payload = {
                'APELLIDOS_Y_NOMBRES': btn.getAttribute('data-nombre'),
                'NOTA1': btn.getAttribute('data-nota1'),
                'NOTA2': btn.getAttribute('data-nota2'),
                'FALLAS1': btn.getAttribute('data-fallas1'),
                'FALLAS2': btn.getAttribute('data-fallas2')
            };
            try {
                const res = await fetch('{{ url_for('sugerencia') }}', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await res.json();
                document.getElementById('sugerencia-contenido').innerText = data.sugerencia || 'Sin sugerencia.';
                const btnReport = document.getElementById('btn-reportar-sugerencia');
                if (btnReport) {
                    btnReport.href = '{{ url_for('reportar') }}' + '?texto=' + encodeURIComponent(data.sugerencia || '');
                    btnReport.style.display = 'inline-block';
                }
                new bootstrap.Modal(document.getElementById('sugerenciaModal')).show();
            } catch (err) {
                console.error(err);
                alert('Error al solicitar sugerencia');
            }
        });
    });

    // Guardar seleccionados (igual que antes)
    document.getElementById('btn-guardar-riesgo').addEventListener('click', async () => {
        const seleccionados = [];
        document.querySelectorAll('.seleccionar-riesgo').forEach(cb => {
            if (cb.checked) {
                try { seleccionados.push(JSON.parse(cb.value)); } catch(e){ console.warn(e); }
            }
        });
        if (seleccionados.length === 0) { alert('No hay estudiantes seleccionados.'); return; }
        try {
            const res = await fetch('{{ url_for('guardar_riesgo') }}', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ seleccion: seleccionados })});
            const data = await res.json();
            if (data.ok) alert('Guardados: ' + data.guardados);
            else alert('No se guardaron: ' + (data.message || 'error'));
        } catch (err) { console.error(err); alert('Error guardando.'); }
    });

    // Mis guardados (botÃ³n inferior)
    const btnBottom = document.getElementById('btn-mis-guardados-bottom');
    if (btnBottom) {
        btnBottom.addEventListener('click', async () => {
            btnBottom.disabled = true; btnBottom.innerText = 'Cargando...';
            try {
                const res = await fetch('{{ url_for('mis_guardados') }}');
                if (!res.ok) { alert('Error cargando guardados'); return; }
                const data = await res.json();
                let html = '';
                if (!data || data.length === 0) html = '<p>No hay estudiantes guardados.</p>';
                else {
                    html = '<div class="table-responsive"><table class="table"><thead><tr><th>Nombre</th><th>Materia</th><th>Programa</th><th>Nota1</th><th>Nota2</th><th>Fallas</th><th>Fecha</th></tr></thead><tbody>';
                    data.forEach(r => {
                        const fallas = (r.fallas1 || 0) + (r.fallas2 || 0);
                        const fecha = r.fecha_guardado && r.fecha_guardado._seconds ? new Date(r.fecha_guardado._seconds * 1000).toLocaleString() : (r.fecha_guardado && r.fecha_guardado.iso ? r.fecha_guardado.iso : '');
                        html += `<tr><td>${r.nombre||''}</td><td>${r.materia||''}</td><td>${r.programa||''}</td><td>${r.nota1||''}</td><td>${r.nota2||''}</td><td>${fallas}</td><td>${fecha}</td></tr>`;
                    });
                    html += '</tbody></table></div>';
                }
                document.getElementById('mis-guardados-list-bottom').innerHTML = html;
                new bootstrap.Modal(document.getElementById('misGuardadosModalBottom')).show();
            } catch (err) { console.error(err); alert('Error al cargar guardados'); }
            finally { btnBottom.disabled = false; btnBottom.innerText = 'ðŸ“š Ver mis guardados'; }
        });
    }

    </script>
</body>
</html>
